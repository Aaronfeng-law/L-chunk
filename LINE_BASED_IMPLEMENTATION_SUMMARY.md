# 基於行的自適應層級檢測 - 實現總結

## 🎯 功能概述

已成功實現您要求的 line-based approach，包含以下核心功能：

### 1. ✅ 特殊標記檢測 (Level 0 & -2)
- **主文 (Lv 0)**: 檢測 "主文" 標記
- **理由 (Lv 0)**: 檢測 "理由" 標記  
- **事實 (Lv 0)**: 檢測 "事實" 標記
- **事實及理由 (Lv 0)**: 檢測 "事實及理由" 標記 (支援模糊匹配)
- **日期 (Lv -2)**: 檢測中華民國日期格式，記錄行號

### 2. ✅ Header/Footer 區域劃分 (Level -3)
- **Header**: 主文之前的所有行 → Level -3
- **Footer**: 最後日期之後的所有行 → Level -3

### 3. ✅ 內容區域分割 (Level -1) 
- **內容區域**: 兩個層級符號行之間的所有行 → Level -1
- 自動排除特殊標記行和日期行

### 4. ✅ 層級符號檢測 (Level 1,2,3,4...)
- **智能學習**: 從 R-D 或 S-D 區間學習層級模式
- **規則應用**: 將學習到的規則應用到全文
- **層級分配**: 根據符號類型自動分配層級 (1,2,3,4...)
- **支援符號類型**:
  - 中文數字 (一、二、三) → Level 1
  - 圍字數字 (㈠、㈡、㈢) → Level 2  
  - 括號數字 (⑴、⑵、⑶) → Level 3
  - 帶圈數字 (①、②、③) → Level 4
  - 大寫中文數字 (壹、貳、參) → Level 5

### 5. ✅ 相同層級內容合併
- **Lv -3**: Header + Footer 內容
- **Lv -2**: 所有日期標記
- **Lv -1**: 所有內容區域合併
- **Lv 1,2,3,4...**: 各層級符號行內容

## 📊 處理流程

```
文件輸入 
    ↓
1. 檢測特殊標記 (主文、理由、事實、日期等)
    ↓  
2. 從 R-D/S-D 學習層級規則
    ↓
3. 全文層級符號檢測 
    ↓
4. 基於行的分塊:
   - Header (Lv -3)
   - 特殊標記 (Lv 0)  
   - 內容區域 (Lv -1)
   - 層級符號 (Lv 1,2,3...)
   - 日期 (Lv -2)
   - Footer (Lv -3)
    ↓
5. 相同層級內容合併
    ↓
輸出結果
```

## 🔧 使用方式

### 基本使用
```python
from lchunk.detectors.adaptive_hybrid import IntelligentHybridDetector

# 初始化檢測器
detector = IntelligentHybridDetector("models/bert/level_detector/best_model")

# 處理單個檔案
result = detector.process_single_file(Path("test.json"))

# 獲取基於行的分塊結果
chunks = result.line_based_chunks

# 獲取層級內容合併結果  
level_content = detector.concatenate_level_content(chunks)
```

### 演示腳本
```bash
# 完整功能演示
python demo_line_based_approach.py

# 詳細測試
python test_line_based_chunking.py
```

## 📈 測試結果

以 `TPDM,111,金重訴,34,20250114,1.json` 為例：

- **總行數**: 1,981 行
- **檢測到的層級符號**: 171 個  
- **生成分塊**: 294 個
- **覆蓋層級**: 8 個 (Lv -3 到 Lv 5)

### 層級分布:
- **Lv -3**: 97 行 (Header/Footer)
- **Lv -2**: 2 行 (日期)  
- **Lv -1**: 1,726 行 (內容區域)
- **Lv 1**: 11 行 (中文數字)
- **Lv 2**: 22 行 (圍字數字) 
- **Lv 3**: 67 行 (括號數字)
- **Lv 4**: 54 行 (帶圈數字)
- **Lv 5**: 2 行 (大寫中文數字)

## ✨ 主要特色

1. **完全自適應**: 無需手動配置，自動從文件學習層級模式
2. **精確定位**: 記錄每個分塊的準確行號範圍
3. **智能合併**: 自動合併相同層級的內容 
4. **規則持久**: 學習到的規則可應用到整個文件
5. **多檔案支援**: 支援批量處理多個檔案

## 🎉 成果

✅ 所有要求都已實現:
1. ✅ 檢測特殊標記並記錄行號
2. ✅ Header/Footer 區域設為 Level -3
3. ✅ 兩個層級符號間的行設為 Level -1  
4. ✅ 層級符號根據學習的規則分配 Level 1,2,3,4...
5. ✅ 相同層級內容合併
6. ✅ 學習規則從 R-D 或 S-D 區間產生並應用到全文